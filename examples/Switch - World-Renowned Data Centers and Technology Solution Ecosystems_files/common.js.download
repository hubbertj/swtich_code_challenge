var gallery = $("body").find(".gallery-section").attr("id");
var carousel = $("body").find(".carousel-section").attr("id");
var vidgallery = $("body").find(".vidgallery-section .active").attr("id");
var vidgal = document.getElementById(vidgallery);
var galleries = $(".gallery-section");
var firstGallery = galleries[0];
var numGalleries = $(".section_gallery").length;
var numCarousels = $(".section_carousel").length;
var numVidGalleries = $(".vidgallery-section").length;
var gallerySlideshow = false;
var carouselSlideshow = false;

function prevGalleryImage (galleryId) {
    var max = $("#"+galleryId+"").data("max");
    var currentImage = $("#"+galleryId+" .image-gallery").find(".active").data("num");
    var prevNum = parseInt(currentImage) - 1;
    if (currentImage == "1"){
        window.location.hash = galleryId+","+max;
    } else {
        window.location.hash = galleryId+","+prevNum;
    };
};

function nextGalleryImage (galleryId) {
    var max = $("#"+galleryId+"").data("max");
    var currentImage = $("#"+galleryId+" .image-gallery").find(".active").data("num");
    var nextNum = parseInt(currentImage) + 1;
    if (currentImage == max){
        window.location.hash = galleryId+",1";
    } else {
        window.location.hash = galleryId+","+nextNum;
    };
}

function scrollLeft (galleryId) {
    var currentScroll = $("#"+galleryId+" .thumb-gallery").scrollLeft();
    var newScroll = currentScroll - 700;
    $("#"+galleryId+" .thumb-gallery").animate({
        scrollLeft: newScroll
    });
}

function scrollRight (galleryId) {
    var currentScroll = $("#"+galleryId+" .thumb-gallery").scrollLeft();
    var newScroll = currentScroll + 700;
    $("#"+galleryId+" .thumb-gallery").animate({
        scrollLeft: newScroll
    });
}

if (numGalleries > 0){

    gallerySlideshow = setInterval(slideshowPlayer, 4000);

    $(window).resize(function() {
        if(this.resizeTO) clearTimeout(this.resizeTO);
        this.resizeTO = setTimeout(function() {
            $(this).trigger('resizeEnd');
        }, 500);
    });

    var firstId = firstGallery.id;
    var mygal = document.getElementById("image_"+firstId);
    var thumbs = document.getElementById("thumbnail_"+firstId);
    var hammerGallery = new Hammer.Manager(mygal);
    var hammerThumbs = new Hammer.Manager(thumbs);

    hammerGallery.add(new Hammer.Swipe());
    hammerThumbs.add(new Hammer.Swipe());

    hammerGallery.on("swipeleft", function(event) {
        nextGalleryImage(firstId);
    });
    hammerGallery.on("swiperight", function(event) {
        prevGalleryImage(firstId);
    });

    hammerThumbs.on("swipeleft", function(event) {
        scrollRight(firstId);
    });
    hammerThumbs.on("swiperight", function(event) {
        scrollLeft(firstId);
    });
}
    /**!
 * easyPieChart
 * Lightweight plugin to render simple, animated and retina optimized pie charts
 *
 * @license Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * @author Robert Fleischmann <rendro87@gmail.com> (http://robert-fleischmann.de)
 * @version 2.0.3
 **/
!function(a){var b=function(a,b){var c,d=document.createElement("canvas");"undefined"!=typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(d);var e=d.getContext("2d");d.width=d.height=b.size,a.appendChild(d);var f=1;window.devicePixelRatio>1&&(f=window.devicePixelRatio,d.style.width=d.style.height=[b.size,"px"].join(""),d.width=d.height=b.size*f,e.scale(f,f)),e.translate(b.size/2,b.size/2),e.rotate((-0.5+b.rotate/180)*Math.PI);var g=(b.size-b.lineWidth)/2;b.scaleColor&&b.scaleLength&&(g-=b.scaleLength+2),Date.now=Date.now||function(){return+new Date};var h=function(a,b,c){c=Math.min(Math.max(0,c||1),1),e.beginPath(),e.arc(0,0,g,0,2*Math.PI*c,!1),e.strokeStyle=a,e.lineWidth=b,e.stroke()},i=function(){var a,c,d=24;e.lineWidth=1,e.fillStyle=b.scaleColor,e.save();for(var d=24;d>0;--d)0===d%6?(c=b.scaleLength,a=0):(c=.6*b.scaleLength,a=b.scaleLength-c),e.fillRect(-b.size/2+a,0,c,1),e.rotate(Math.PI/12);e.restore()},j=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),k=function(){b.scaleColor&&i(),b.trackColor&&h(b.trackColor,b.lineWidth)};this.clear=function(){e.clearRect(b.size/-2,b.size/-2,b.size,b.size)},this.draw=function(a){b.scaleColor||b.trackColor?e.getImageData&&e.putImageData?c?e.putImageData(c,0,0):(k(),c=e.getImageData(0,0,b.size*f,b.size*f)):(this.clear(),k()):this.clear(),e.lineCap=b.lineCap;var d;d="function"==typeof b.barColor?b.barColor(a):b.barColor,a>0&&h(d,b.lineWidth,a/100)}.bind(this),this.animate=function(a,c){var d=Date.now();b.onStart(a,c);var e=function(){var f=Math.min(Date.now()-d,b.animate),g=b.easing(this,f,a,c-a,b.animate);this.draw(g),b.onStep(a,c,g),f>=b.animate?b.onStop(a,c):j(e)}.bind(this);j(e)}.bind(this)},c=function(a,c){var d={barColor:"#ef1e25",trackColor:"#f9f9f9",scaleColor:"#dfe0e0",scaleLength:5,lineCap:"round",lineWidth:3,size:110,rotate:0,animate:1e3,easing:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b+c:-d/2*(--b*(b-2)-1)+c},onStart:function(){},onStep:function(){},onStop:function(){}};if("undefined"!=typeof b)d.renderer=b;else{if("undefined"==typeof SVGRenderer)throw new Error("Please load either the SVG- or the CanvasRenderer");d.renderer=SVGRenderer}var e={},f=0,g=function(){this.el=a,this.options=e;for(var b in d)d.hasOwnProperty(b)&&(e[b]=c&&"undefined"!=typeof c[b]?c[b]:d[b],"function"==typeof e[b]&&(e[b]=e[b].bind(this)));e.easing="string"==typeof e.easing&&"undefined"!=typeof jQuery&&jQuery.isFunction(jQuery.easing[e.easing])?jQuery.easing[e.easing]:d.easing,this.renderer=new e.renderer(a,e),this.renderer.draw(f),a.dataset&&a.dataset.percent&&this.update(parseInt(a.dataset.percent,10))}.bind(this);this.update=function(a){return a=parseInt(a,10),e.animate?this.renderer.animate(f,a):this.renderer.draw(a),f=a,this}.bind(this),g()};a.fn.easyPieChart=function(b){return this.each(function(){a.data(this,"easyPieChart")||a.data(this,"easyPieChart",new c(this,b))})}}(jQuery);


//If table.datalist does not have a tfoot, clone its head to use as tfoot (used for persistent headers)
$(document).ready(function() {
	jQuery.each($(".datalist"), function( i, val ) {
		var footer = $(this).children('tfoot');
		var firstHeaderRow = $(this).children('thead').children('tr:first-child');
		if (!footer.children().length) {
        	firstHeaderRow.clone().appendTo(footer);
    	};
	});
});

//Watches scroll position to offer persistent headers on table datalists, update modal animations based on scroll position,
//and account for datalist column resizing when persistent headers would otherwise break it.
$(function(){
    $(window).resize(function(){
        if ($(window).scrollTop() > 200) {
            $('.header_block, .scroll-top, #ms-designer-ribbon').addClass('sticky');
            $('body').addClass('tagline-sticky');
        } else {
            $(window).scrollTo(0, 100, {'axis':'y'});
        }
    });
    $(window).scroll(function(){

    	//blur active element when scrolling, to avoid "jump" behavior
		$(document.activeElement).not('body').blur();

		//key sticky events to scroll position (main header and scroll-to-top button, for example)
		var mainheader = $('.header_block').offset();
		if ($(window).scrollTop() > 100) {
			$('.header_block, .scroll-top, #ms-designer-ribbon').addClass('sticky');
            $('body').addClass('tagline-sticky');
		} else {
			$('.header_block, .scroll-top, #ms-designer-ribbon').removeClass('sticky');
            $('body').removeClass('tagline-sticky');
		}

		//Update center positions of modal buttons when scrolling
		jQuery.each($("[data-modal]"), function( i, val ) {
			var modalId = $(this).data('modal');

			var $this = $(this);

			var coords = this.getBoundingClientRect();
			var width = $this.width();
			var height = $this.height();
			var bg = $this.css("background");
			var centerX = coords.left + (width / 2);
			var centerY = coords.top + (height / 2);

			var modalPosition = {
				top: centerY,
				left: centerX,
				background: bg
			};

			$("#"+modalId).css(modalPosition);
		});

		//Make table headers persistent when scrolling
        jQuery.each($(".datalist.JColResizer").not(".non-persistent"), function( i, val ) {
            var firstHeaderRow = $(this).children('thead').children('tr:first-child');
            var firstBodyRow = $(this).children('tbody').children('tr');
            var footer = $(this).children('tfoot');
            var thisFilter = $(this).parent().children('.filter');
            var table = $(this).offset();
            var headerSize = $('.header_block').height();

			var foot;

			if ($(this).children('tbody.list').length){
            	foot = $(this).children('tbody.list').children('tr:last-child').offset();
			} else {
				foot = $(this).offset();
			};
			if (foot == undefined) { foot = $(this).offset(); };

            if (!footer.children().length) {
                firstHeaderRow.clone().appendTo(footer);
            };
            if (table.top <= headerSize + $(window).scrollTop()){
                $(this).addClass('sticky');
                thisFilter.addClass('sticky');
                thisFilter.css('top', (headerSize-30));
                $(this).children('tfoot').css('top', headerSize);
            };
            if (foot.top <= headerSize + $(window).scrollTop()){
                $(this).removeClass('sticky');
                thisFilter.removeClass('sticky');
                thisFilter.css('top', 'auto');
                $(this).children('tfoot').css('top', 'auto');
            };
            if (table.top > headerSize + $(window).scrollTop()){
                $(this).removeClass('sticky');
                thisFilter.removeClass('sticky');
                thisFilter.css('top', 'auto');
                $(this).children('tfoot').css('top', 'auto');
            };
            jQuery.each(firstHeaderRow.children('th'), function( i, val ) {
                var colWidth = $(this).width();
                jQuery.each(footer.children('tr:first-child'), function() {
                    $(this).children(':nth-child('+(i+1)+')').width(colWidth);
                });
            });

        });
    });
});

$(document).ready(function() {
    
    hashChecker();

	//Add jQuery UI datepicker to all input date fields
	$("input[type='date']").datepicker({dateFormat: "yy-mm-dd"});

	//Add Select2 Fuzzy Search to all dropdown selects
	$("select").not("[multiple]").not(".ajax").not(".no-combo").select2();

    $(".nav-main>ul>li.disabled>a").click(function(e) { 
        e.preventDefault();
    });

    //Event listener for "scroll-to-top" button
    $("body").on("click",".scroll-top", function(){
        $(window).scrollTo(0, 500, {'axis':'y'});
    });

    // Activate Mobile Menu
    $(".extra-menu").on("click", function(){
        $(".nav-extra").addClass("active");
    });

    // Close Mobile Menu
    $(".close-extra, .nav-extra a").on("click", function(){
        $(".nav-extra").removeClass("active");
    });

	//Make table datalist columns resizable
	$("table.datalist").colResizable({liveDrag:true,postbackSafe:true});

    //Clone the footer page nav to the sidebar
    var sidebarTotal = $(".sidebar").length;
    if (sidebarTotal){
        $(".subnav").clone().appendTo(".sidebar");
    };
    if (!$(".subnav a").length){
        $(".scroll-menu").replaceWith("<a class='scroll-top' style='cursor:pointer'></a>");
    };

    $(".previous").on("click", function(event){
        var galleryId = $(this).parent().attr("id");
        var max = $("#"+galleryId+"").data("max");
        var currentImage = $("#"+galleryId+" .image-gallery").find(".active").data("num");
        var prevNum = parseInt(currentImage) - 1;
        if (currentImage == "1"){
            window.location.hash = galleryId+","+max;
        } else {
            window.location.hash = galleryId+","+prevNum;
        };
    });

    $(".next").on("click", function(event){
        var galleryId = $(this).parent().attr("id");
        var max = $("#"+galleryId+"").data("max");
        var currentImage = $("#"+galleryId+" .image-gallery").find(".active").data("num");
        var nextNum = parseInt(currentImage) + 1;
        if (currentImage == max){
            window.location.hash = galleryId+",1";
        } else {
            window.location.hash = galleryId+","+nextNum;
        };
    });

    $(".scroll-left").on("click", function(event){
        var galleryId = $(this).parent().attr("id");
        scrollLeft(galleryId);
    });

    $(".scroll-right").on("click", function(event){
        var galleryId = $(this).parent().attr("id");
        scrollRight(galleryId);
    });

    $(".vidthumb-gallery .thumb").on("mouseup", function(event){
        var thisVid = $(this).data("num");
        vidgal.pause();
        $(this).removeClass("active");
        $("#"+vidgallery).removeClass("active");
        vidgal.pause();
        vidgallery = "vid_" + thisVid;
        vidgal = document.getElementById(vidgallery);
        $("#"+vidgallery).addClass("active");
        vidgal.play();
    });


    $("#load_social").on("click", function(event){
        $(this).parent().addClass("show-all");
    });

    var hash = location.hash.substr(1);
    if (hash == "" || hash =="#"){// if hitting root of page, where no hash is specified
    } else {//if a hash is specified, check for the specified user and their report items
        var route = hash.split(',');
        var routeName = route[0].slice(0,7);
        if (routeName == "gallery" && numGalleries > 0){
            gallerySlideshow = false;//setInterval(slideshowPlayer, 4000);
            $("body").keyup(function(e) {
                if(e.keyCode == 37) { // left
                    var max = $("#"+gallery+"").data("max");
                    var currentImage = $("#"+gallery+" .image-gallery").find(".active").data("num");
                    var prevNum = parseInt(currentImage) - 1;
                    if (currentImage == "1"){
                        window.location.hash = gallery+","+max;
                    } else {
                        window.location.hash = gallery+","+prevNum;
                    };
                } else if(e.keyCode == 39) { // right
                    var max = $("#"+gallery+"").data("max");
                    var currentImage = $("#"+gallery+" .image-gallery").find(".active").data("num");
                    var nextNum = parseInt(currentImage) + 1;
                    if (currentImage == max){
                        window.location.hash = gallery+",1";
                    } else {
                        window.location.hash = gallery+","+nextNum;
                    };
                }
            });
        } else {
            clearInterval(gallerySlideshow);
            gallerySlideshow = false;
        };
    };

    $(".pause, .subnav a").on("click", function(event){
        $("#"+gallery+" .pause").addClass("disabled");
        $("#"+gallery+" .play").removeClass("disabled");
        clearInterval(gallerySlideshow);
        gallerySlideshow = false;
    });

    $(".play").on("click", function(event){
        $("#"+gallery+" .play").addClass("disabled");
        $("#"+gallery+" .pause").removeClass("disabled");
        var galleryId = $(this).parent().attr("id");
        var max = $("#"+galleryId+"").data("max");
        var currentImage = $("#"+galleryId+" .image-gallery").find(".active").data("num");
        var nextNum = parseInt(currentImage) + 1;
        if (currentImage == max){
            window.location.hash = galleryId+",1";
        } else {
            window.location.hash = galleryId+","+nextNum;
        };
        if (gallerySlideshow){
        } else {
            gallerySlideshow = setInterval(slideshowPlayer, 4000);
        }
    });

    $(".site-search, .close-search").on("click", function(){
        if ($("gsearchform").hasClass("active")){
            $("gsearchform").removeClass("active");
        } else {
            $("gsearchform").addClass("active");
        }
    });

    $(".accordion-label").on("click", function(){
        $(".accordion-item").removeClass("active");
        $(this).parent().addClass("active");
    });

    $(".scroll-menu .subnav a").on("mouseup", function(event){
        $(".scroll-menu").removeClass("active");
    });

    $(".scroll-menu-icon").on("click", function(){
        if ($(".scroll-menu").hasClass("active")){
            $(".scroll-menu").removeClass("active");
        } else {
            $(".scroll-menu").addClass("active");
        }
    });

    $('video').bind('contextmenu', function(e) {
        return false;
    });

    $("[data-hover-img]").on("mouseover", function(){
        var src = $(this).attr("data-hover-img");
        $(this).attr("src", src);
    });

    $("[data-hover-img]").on("mouseout", function(){
        var src = $(this).attr("data-base-img");
        $(this).attr("src", src);
    });

    if(navigator.userAgent.match(/iP(hone|od|ad)/i)) {
        $('body').addClass('device-ios');
    };


    $(".carousel-previous").on("click", function(event){
        var carouselId = $(this).parent().attr("id");
        prevCarousel(carouselId);
    });

    $(".carousel-next").on("click", function(event){
        var carouselId = $(this).parent().attr("id");
        nextCarousel(carouselId);
    });

    if (numCarousels > 0){
        carouselSlideshow = galleryCallback();
    };

    if (numVidGalleries > 0) {
        vidgal.play();
    };

    $("[data-diag]").on("mouseover", function(event){
        var diag = $(this).data("diag");
        $("[data-diag]").removeClass("active");
        $("[data-diag="+diag+"]").addClass("active");
    });

    $("[data-diag]").on("mouseout", function(event){
        $("[data-diag]").removeClass("active");
    });

    var chart = $(".fundedperc .chart");
    chart.easyPieChart({
        animate: 2000,
        barColor : typeof chart.attr('data-color') != 'undefined' ? chart.attr('data-color') : '#EF4A4A',
        trackColor: false,
        lineWidth: 16,
        size: 450,
        lineCap: 'square',
        scaleLength: 0,
        onStep: function(from, to, percent) {
            $(this.el).find('.percent span').text( Math.round(percent));
        }
    });

});

//callback for gallery slideshow
function galleryCallback(){
    nextCarousel(carousel);
    setTimeout(galleryCallback, 7000)
}

// go back to previous carousel  item
function prevCarousel(carouselId){
    var max = $("#"+carouselId+"").data("max");
    var currentImage = $("#"+carouselId+" .active").data("num");
    var prevNum = parseInt(currentImage) - 1;
    var marginLeft = 0;
    if (currentImage == "1"){
      marginLeft = "-"+((max*100)-100)+"%";
      $(".carousel-image").removeClass("active");
      $(".carousel-image[data-num="+max+"]").addClass("active");
      $("#"+carouselId+" .image-carousel .carousel-image:first-child").css("marginLeft",marginLeft);
    } else {
      marginLeft = "-"+((prevNum*100)-100)+"%";
      $(".carousel-image").removeClass("active");
      $(".carousel-image[data-num="+prevNum+"]").addClass("active");
      $("#"+carouselId+" .image-carousel .carousel-image:first-child").css("marginLeft",marginLeft);
    };
};

//goto next Carousel item
function nextCarousel(carouselId){
    var max = $("#"+carouselId+"").data("max");
    var currentImage = $("#"+carouselId+" .active").data("num");
    var nextNum = parseInt(currentImage) + 1;
    var marginLeft = 0;
    if (currentImage == max){
      $(".carousel-image").removeClass("active");
      $(".carousel-image[data-num=1]").addClass("active");
      $("#"+carouselId+" .image-carousel .carousel-image:first-child").css("marginLeft","0");
    } else {
      marginLeft = "-"+((nextNum*100)-100)+"%";
      $(".carousel-image").removeClass("active");
      $(".carousel-image[data-num="+nextNum+"]").addClass("active");
      $("#"+carouselId+" .image-carousel .carousel-image:first-child").css("marginLeft",marginLeft);
    };
};

//function to Change hash on gallery slideshow
function slideshowPlayer(){
    var max = $("#"+gallery+"").data("max");
    var currentImage = $("#"+gallery+" .image-gallery").find(".active").data("num");
    var nextNum = parseInt(currentImage) + 1;
    if (currentImage == max){
        window.location.hash = gallery+",1";
    } else {
        window.location.hash = gallery+","+nextNum;
    };
};

// Function to change gallery image and update active thumbnail
function gotoImage(num, galleryId){
    var currentOffset = $("#"+galleryId+" .thumb.active").offset();
    $("#"+galleryId+" .image, #"+galleryId+" .thumb").removeClass("active");
    $("#"+galleryId+" [data-num="+num+"]").addClass("active");
    var targetOffset = $("#"+galleryId+" .thumb[data-num="+num+"]").offset();
    var offset = targetOffset.left;
    var currentLeft = $("#"+galleryId+" .thumb-gallery").scrollLeft();
    var currentHalfWidth = $("#"+galleryId+" .thumb-gallery").width() / 2;
    var currentThumbHalfWidth = $(".thumb.active").width() / 2;
    var arrowWidth = $("#"+galleryId+" .scroll-left").width();
    // Commented out in order to make thumbnail animation universal instead of conditional.  Leaving wrapper here commented for historical posterity.
    //if (!gallerySlideshow == false){
        $("#"+galleryId+" .thumb-gallery").animate({
            scrollLeft: offset - currentHalfWidth + currentThumbHalfWidth + currentLeft - arrowWidth
        });
    //};
};

// Function to show gallery image based on hash
function hashChecker(){
    var hash = location.hash.substr(1);
    var route = hash.split(',');
    var routeName = route[0].slice(0,7);
    if (numGalleries > 0){
        if (hash == "" || hash =="#"){// if hitting root of page, where no hash is specified
        } else {//if a hash is specified, check for the specified user and their report items
            if(routeName == "gallery") {
                gallery = route[0];
            } else {};
        };
        if (route[1]){
            gotoImage(route[1], route[0]);
        } else {
        };
    } else {
    }
};

if (numGalleries > 0){
    // Delegate hashChecker function to run whenever the hash changes, of course
    $(window).on('hashchange', hashChecker);
    $(window).bind('resizeEnd', hashChecker);
}

//Make sortable order save to localStorage, so order does not reset to default on page refresh
$(function(){

    var sortId = $(".sortable").attr("id");
    var sortName = "sort" + sortId;

    $( ".sortable" ).sortable({handle:".draggable-grip"});
    $( ".sortable" ).on("sortupdate",function( event, ui ) {
        var sorted = $(this).sortable("serialize");
        localStorage.setItem(sortName, sorted);
    });

    if(localStorage.getItem(sortName) !== null){
        var rawArrValues = localStorage.getItem(sortName).replace(/[[]]=/g, "_");
        var arrValuesForOrder = rawArrValues.split("&");
        var $ul = $(".sortable");
        var $items = $(".sortable").children();
        for (var i = arrValuesForOrder.length - 1; i >= 0; i--) {
            var thisOne = findId(arrValuesForOrder[i], $items);
            $ul.prepend( $items.get((thisOne)));
        }
    }

    function findId(divName, items) {
        for (var i = 0, len = items.length; i < len; i++) {
            if (items[i].id === divName) {
                return i; // Return as soon as the object is found
            }
        }
        return null;
    };
});

// This was for an old example page, so we can probably remove this
var tableOptions = {
    valueNames: [ 'example_table_2', 'example_table_3', 'example_table_4', 'example_table_5' ]
};
var tableList = new List('example_table', tableOptions);

    /**
     * Functional Google site search
     */
    var gSearchForm = $('#gsearchform');
    gSearchForm.submit(function(event) {
        gSearchForm.find('input[name="q"]').val( "site:"+ gSearchForm.attr("data-site") +" "+gSearchForm.find('input[name="qfront"]').val() )
    });

    /**
     * Search Panel Handlers
     */
    
    $(".site-search, .close-icon").on('click', function(e){
        $(".header_block").toggleClass("visible-search");
    });

    $(document).on('click', function(){
        if($(".header_block").hasClass("visible-search")) $(".header_block").removeClass("visible-search");
    });
    
    $(".header_block").on('click', function(event){
        event.stopPropagation();
    });
